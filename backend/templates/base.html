
<!DOCTYPE html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
	href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
	rel="stylesheet"
/>

<body>
	<div class="full-body-container">
		<div class="top-text">
			<div class="google-colors">
				<h1 id="title-color">CuisineCheck</h1>
				<p id="small-title">Philadelphia</p>
			</div>
				<div class="search-box" onclick="sendFocus()">
					<input
						autocomplete="off"
						placeholder="Search for your favorite restaurant"
						id="filter-text-val"
						onkeyup="if (event.keyCode === 13) { filterText(); } else {filterText(), editDistance()}" 
					/>
					<ul id="restaurant-list"></ul>
				</div>
					
			</div>
			<div class="container">
				<h2 class="input-heading">Additional Inputs</h2>
				<div class="input-container">
				  <div class="rating-box">
					<label for="rating-input">Minimum Rating:</label>
					<input type="range" id="rating-input" name="rating-input" min="0" max="5" step="1" value="0" />
					<span id="rating-value">0</span>
				  </div>
				  <div class="blacklist-box">
					<label for="blacklist-input">Blacklist a Restaurant:</label>
					<input type="text" id="blacklist-input" name="blacklist-input" />
				  </div>
				</div>
			  </div>
			<div id="answer-box"></div>
		</div>
	</div>

	<script>
		const filterTextVal = document.querySelector('#filter-text-val');
		const restaurantList = document.querySelector('#restaurant-list');
		const searchBox = document.querySelector('.search-box');

		document.addEventListener('click', (event) => {
			if (!searchBox.contains(event.target)) {
				restaurantList.innerHTML = '';
			}
		});

		restaurantList.addEventListener('click', (event) => {
			filterTextVal.value = event.target.textContent.trim();
			restaurantList.innerHTML = '';
			filterText();
		});


		function editDistance(){
			fetch('get_names')
				.then((response) => response.json())
				.then((data) => {
					const text = document.getElementById('filter-text-val').value;
					if (text == ""){
						const dropdown = document.getElementById('restaurant-list');
						dropdown.innerHTML = ''; 
						return;
					}
					const distances = data.map((name) => ({
						name,
						distance: editDistanceHelper(name.toLowerCase(), text.toLowerCase())
					}));
					
					distances.sort((a, b) => a.distance - b.distance);
					
					const topNames = distances.slice(0, 5).map((d) => d.name);
					
					const dropdown = document.getElementById('restaurant-list');

					dropdown.innerHTML = ''; 
					
					topNames.forEach((name) => {
						const menuItem = document.createElement('li');
						menuItem.classList.add('dropdown-item');
						menuItem.href = '#';
						menuItem.textContent = name;
						dropdown.appendChild(menuItem);
						
					});
				})	
		}

		function editDistanceHelper(str1, str2) {
			const m = str1.length;
			const n = str2.length;
			const dp = [];

			for (let i = 0; i <= m; i++) {
				dp[i] = [];
				for (let j = 0; j <= n; j++) {
				dp[i][j] = 0;
				}
			}

			for (let i = 1; i <= m; i++) {
				dp[i][0] = i;
			}
			for (let j = 1; j <= n; j++) {
				dp[0][j] = j;
			}

			for (let i = 1; i <= m; i++) {
				for (let j = 1; j <= n; j++) {
				if (str1[i-1] === str2[j-1]) {
					dp[i][j] = dp[i-1][j-1];
				} else {
					dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
				}
				}
			}

			return dp[m][n];
		}

		// Get the slider input element and rating-value span element
		const ratingInput = document.getElementById('rating-input');
		const ratingValue = document.getElementById('rating-value');

		const blackList = document.getElementById('blacklist-input');

		// Add an event listener to the slider input element
		ratingInput.addEventListener('input', () => {
			// Set the value of the rating-value span element to the current value of the slider
			ratingValue.innerText = ratingInput.value;
		});
		
		function answerBoxTemplate(
			name,
			address,
			stars,
			categories,
			review,
			match
		) {
			if (document.getElementById('filter-text-val').value == '') {
				return ``;
			}
			
			const bgColor = match ? '#fff6f6' : '#f9f9f9';
			return `<div class='border box-template' style='background-color: ${bgColor};'>
                <h3 class='episode-title'>${name}</h3>
                <p class='company-address'>${address}</p>
                <p class='star-ratings'>${'<span></span>'.repeat(stars)}</p>
                <p class='category-list'>${categories}</p>
                <p class='review' style='margin-top: 15px;'>Most useful review: ${review}</p>
            </div>`;
		}

		function sendFocus() {
			document.getElementById('filter-text-val').focus();
		}

		function filterText() {
			document.getElementById('answer-box').innerHTML = '';
			
			//console.log(document.getElementById('filter-text-val').value);
			var searchParams = new URLSearchParams({
				title: document.getElementById('filter-text-val').value,
			});
			searchParams.append("blacklist", blackList.value) // # Temp example for search "Marathon Grill"
			searchParams.append("min_rating", ratingInput.value) // temp value for min_rating
			fetch('/episodes?' + searchParams.toString())
				.then((response) => response.json())
				.then((data) =>
					data.forEach((row, index) => {
						if (index == 0) {
							// Query company
							//console.log('User query company info: ', row);
							if (row.address == null){
								return;
							}
							let tempDiv = document.createElement('div');
							tempDiv.innerHTML = answerBoxTemplate(
								row.name,
								row.address,
								row.stars,
								row.categories,
								row.useful_review,
								true
							); // TODO: Change to show more attributes than just name and useful review
							document.getElementById('answer-box').appendChild(tempDiv);
						} else {
							row.forEach((r, i) => {
								// Matched companies
								//console.log('Match #', i + 1, ' company info: ', r);
								let tempDiv = document.createElement('div');
								tempDiv.innerHTML = answerBoxTemplate(
									r.name,
									r.address,
									r.stars,
									r.categories,
									r.useful_review,
									false
								); // TODO: Change to show more attributes than just name and useful review
								document.getElementById('answer-box').appendChild(tempDiv);
							});
						}
					})
				);
		}
	</script>
</body>
